<link rel="import" href="./data-table.html">
<link rel="import" href="../behavior/google-scope.html"/>
<link rel="import" href="/bower/google-signin/google-signin-aware.html">
<link rel="import" href="/bower/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="/bower/paper-card/paper-card.html">
<link rel="import" href="/bower/paper-fab/paper-fab.html">

<dom-module id="party-card">
  <template>
    <style is="custom-style" include="iron-flex">
      :host ::content .title-text paper-input paper-input-container div.underline .unfocused-line {
        display: none;
      }

      :host ::content .title-text paper-input .input-content.paper-input-container input {
        font-size: 24px;
      }

      :host paper-card {
        width: calc(100% - 16px);
      }
    </style>
    <google-signin-aware scopes="{{scopes}}" signed-in="{{isSignedIn}}"></google-signin-aware>
    <paper-card>
      <div class="header paper-card">
        <div class="title-text paper-card">
          <span class="layout horizontal">
            <template is="dom-if" if="{{editing}}">
              <editing-item class="flex" item="{{party.name}}"></editing-item>
            </template>
            <template is="dom-if" if="{{!editing}}">
              <span>{{party.name}}</span>
            </template>
          </span>
        </div>
      </div>
      <div class="card-content">
        <data-table columns="[[columns]]"
                    rows="{{party.characters}}"
                    editable="{{editing}}"></data-table>
      </div>
      <div class="card-actions">
        <template is="dom-if" if="{{editing}}">
          <paper-button raised on-tap="addCharacter">Add Character</paper-button>
          <paper-button raised on-tap="saveParty" disabled="{{!canSave}}">Save</paper-button>
        </template>
        <template is="dom-if" if="{{!editing}}">
          <paper-button raised on-tap="editParty">Use Party</paper-button>
          <paper-button raised class="secondary" on-tap="deleteParty">Delete Party</paper-button>
        </template>
      </div>
    </paper-card>
  </template>
  <script>
    Polymer({
      id: 'party-card',
      behaviors: [rptools.GoogleScopeBehavior],
      properties: {
        columns: {
          type: Array,
          value: function () {
            return [
              {label: 'Name', id: 'name', type: 'text', showing: true},
              {label: 'AC', id: 'armorClass', type: 'number', showing: true},
              {label: 'Initiative', id: 'initiative', type: 'number', showing: true},
              {label: 'Current HP', id: 'currentHitPoints', type: 'number', showing: true},
              {label: 'Max HP', id: 'maxHitPoints', type: 'number', showing: true}
            ];
          }
        },
        canSave: {
          type: Boolean,
          computed: '_canSave(unsaved, party.id)'
        },
        editing: {
          type: Boolean,
          value: false
        },
        party: {
          type: Object,
          notify: true
        },
        unsaved: {
          type: Boolean,
          notify: true,
          value: false
        }
      },
      observers: [
        '_partyChanged(party.*)',
        '_rowsChanged(party.characters.*)'
      ],
      _canSave: function (unsaved, id) {
        return unsaved || !id;
      },
      _showColumn: function (column) {
        return column.showing;
      },
      _partyChanged(change) {
        if (change.path != 'party') {
          this.unsaved = true;
        }
      },
      _rowsChanged(change) {
        if (change.base != change.value) {
          this.unsaved = true;
        }
      },
      addCharacter: function () {
        this.push('party.characters', {});
      },
      deleteParty: function () {
        this.fire('delete-party');
      },
      editParty: function () {
        this.fire('edit-party');
      },
      primaryTap: function () {
        if (!this.isSignedIn) {
          return;
        }
        this.fire('primary-tap');
      },
      saveParty: function () {
        this.fire('save-party');
        this.unsaved = false;
      }
    })
  </script>
</dom-module>