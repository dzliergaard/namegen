<link rel="import" href="./city/city-page.html">
<link rel="import" href="./name/name-page.html">
<link rel="import" href="/bower/app-route/app-location.html">
<link rel="import" href="/bower/app-route/app-route.html">
<link rel="import" href="/bower/google-apis/google-client-loader.html">
<link rel="import" href="/bower/google-apis/google-js-api.html">
<link rel="import" href="/bower/google-signin/google-signin.html">
<link rel="import" href="/bower/iron-icon/iron-icon.html">
<link rel="import" href="/bower/iron-icons/iron-icons.html">
<link rel="import" href="/bower/iron-icons/social-icons.html">
<link rel="import" href="/bower/iron-media-query/iron-media-query.html">
<link rel="import" href="/bower/iron-pages/iron-pages.html">
<link rel="import" href="/bower/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="/bower/paper-header-panel/paper-header-panel.html">
<link rel="import" href="/bower/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/bower/paper-item/paper-icon-item.html">
<link rel="import" href="/bower/paper-menu/paper-menu.html"/>
<link rel="import" href="/bower/paper-toast/paper-toast.html">
<link rel="import" href="/bower/paper-toolbar/paper-toolbar.html">

<dom-module id="rptools-app">
  <template>
    <style is="custom-style" include="iron-flex iron-flex-alignment">
      :host app-header-layout {
        margin-bottom: 10px;
      }

      :host {
        --paper-toolbar-color: var(--light-theme-text-color);
      }
    </style>
    <app-location route="{{route}}"></app-location>
    <app-route route="{{route}}" pattern="/:page" data="{{location}}"></app-route>
    <google-js-api id="gapi"></google-js-api>
    <google-client-loader id="drive" name="drive" version="v3"></google-client-loader>
    <paper-drawer-panel id="drawer" responsive-width="840px">
      <paper-header-panel drawer mode="seamed">
        <paper-toolbar>
          <google-signin client-id="{{clientId}}" scopes="{{scopes}}"></google-signin>
        </paper-toolbar>
        <paper-menu selected="{{location.page}}" attr-for-selected="name">
          <paper-icon-item name="name" on-tap="closeDrawer">
            <iron-icon item-icon icon="social:person"></iron-icon>
            Name Generator
          </paper-icon-item>
          <paper-icon-item name="city" on-tap="closeDrawer">
            <iron-icon item-icon icon="social:location-city"></iron-icon>
            City Generator
          </paper-icon-item>
        </paper-menu>
      </paper-header-panel>
      <paper-header-panel main mode="scroll">
        <paper-toolbar>
          <paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
          <h2>{{pageName(location.page)}}</h2>
        </paper-toolbar>
        <iron-pages selected="{{location.page}}" attr-for-selected="name">
          <name-page name="name"
                     is-signed-in="{{isSignedIn}}"
                     saved-names="{{userSavedContent.names}}"
                     layout-data="{{layoutData}}"></name-page>
          <city-page name="city" races="{{races}}"
                     is-signed-in="{{isSignedIn}}"
                     saved-cities="{{userSavedContent.cities}}"
                     layout-data="{{layoutData}}"></city-page>
        </iron-pages>
      </paper-header-panel>
    </paper-drawer-panel>
    <paper-toast id="savesuccess" text="User content saved!"></paper-toast>
    <iron-media-query query="(max-width: 480px)" query-matches="{{four}}"></iron-media-query>
    <iron-media-query query="(min-width: 480px) and (max-width: 840px)" query-matches="{{eight}}"></iron-media-query>
    <iron-media-query query="(min-width: 840px)" query-matches="{{twelve}}"></iron-media-query>
  </template>

  <script>
    Polymer({
      is: 'rptools-app',
      properties: {
        four: Boolean,
        eight: Boolean,
        twelve: Boolean,
        races: Array,
        userSavedContent: Object,
        appDataFileMetadata: {
          type: Object,
          value: {
            name: 'content.json',
            parents: ['appDataFolder']
          }
        },
        clientId: {
          type: String,
          value: "455791253437-tbh3r1rc5lg720tnfrlfbi5cm7n5rvm4.apps.googleusercontent.com"
        },
        isSignedIn: {
          type: Boolean,
          value: false
        },
        layoutData: {
          type: Object,
          computed: '_layoutData(four, eight, twelve)'
        },
        listening: {
          type: Boolean,
          value: false
        },
        location: {
          type: String,
          observers: '_setSelected'
        },
        scopes: {
          type: String,
          value: "profile https://www.googleapis.com/auth/drive.appdata"
        }
      },
      listeners: {
        'google-signin-success': 'userSignedIn',
        'google-signed-out': 'userSignedOut'
      },
      observers: [
        'contentUpdated(userSavedContent.names.*)',
        'contentUpdated(userSavedContent.cities.*)',
        'contentUpdated(userSavedContent.names.splices)',
        'contentUpdated(userSavedContent.cities.splices)'
      ],
      ready: function () {
        this.gapi = document.querySelector('google-js-api');
        this.drive = document.querySelector('google-client-loader');
      },
      get updateRequestParams() {
        return {
          path: '/upload/drive/v3/files/' + this.appDataFileMetadata.id,
          method: 'PATCH',
          params: {
            uploadType: 'media',
            alt: 'json'
          },
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(this.userSavedContent)
        }
      },
      _layoutData: function (four, eight, twelve) {
        return {
          fourColumns: four,
          eightColumns: eight,
          twelveColumns: twelve
        };
      },
      closeDrawer: function (event) {
        this.$.drawer.closeDrawer();
      },
      pageName: function (page) {
        switch (page) {
          default:
          case 'name':
            return 'Name Generator';
          case 'city':
            return 'City Generator';
        }
      },
      contentUpdated: function (names) {
        if (!this.listening || !this.isSignedIn) {
          return;
        }
        this.gapi.api.client.request(this.updateRequestParams).execute();
        this.$.savesuccess.open();
      },
      userSignedIn: function () {
        this.isSignedIn = true;
        if (this.drive.api) {
          this.downloadAppDataFile();
        } else {
          this.drive.addEventListener('google-api-load', this.downloadAppDataFile.bind(this));
        }
      },
      userSignedOut: function (e) {
        this.isSignedIn = false;
        this.userSavedContent = {};
      },
      downloadAppDataFile: function (event) {
        if (!this.files) {
          this.files = this.drive.api.files;
        }
        this.files.list({
          spaces: "appDataFolder",
          fields: "files(id,modifiedTime,name,properties)",
          body: JSON.stringify(this.userSavedContent)
        }).then(this.listAppDataFilesCallback.bind(this));
      },

      /* drive callback methods */
      listAppDataFilesCallback: function (response) {
        if (response.result.files.length == 0) {
          this.files.create({
            resource: this.appDataFileMetadata,
            fields: "files(id)"
          }, "{}").then(this.createAppDataFileCallback.bind(this));
        } else {
          this.appDataFileMetadata.id = response.result.files[0].id;
          this.files.get({
            fileId: this.appDataFileMetadata.id,
            alt: "media"
          }).then(this.getAppDataFileCallback.bind(this));
        }
      },
      createAppDataFileCallback: function (err, response) {
        this.appDataFileMetadata.id = response.result;
        this.userSavedContent = {};
        this.listening = true;
      },
      getAppDataFileCallback: function (response) {
        this.userSavedContent = response.result;
        this.listening = true;
      }
    });
  </script>

</dom-module>


